---
title: 'HW 2: Маркетинговая кампания'
author: "Егоров Кирилл, ksegorov"
output: 
  html_document:
    code_folding: hide
---

## Задача

Франчайзи нашей продуктовой сети из соседнего региона решил провести маркетинговую кампанию. Для этого он запросил у нас ответы на интересующие его вопросы для запуска таргетированной рекламы в социальных сетях. Необходимо ответить на указанные вопросы и предсказать отклик рекламной кампании франчайзи, таргетированной на его клиентов по указанным им переменным.

### Загрузка данных и преобразование

```{r message = FALSE, warning=FALSE}
marketing = read.csv("marketing_campaign.csv")
library(tidyverse)
library(rpart)
library(rpart.plot)
```

Для ответа на вопросы заказчика переменные Reponse, Mntwines, Marital_Status были переименованы как 'Отклик на кампанию', 'Траты на вино' и  'Семейное положение' соответственно. Переменная 'Отклик на кампанию' была переобразована из типа character в тип factor для дальйшего использования в статистическом тесте Стьюдента. Для ответа на второй вопрос была создана переменная, показывающая долю товаров, которые были куплены по скидке. Товары по скидке, а точнее переменная NumDealsPurchases была принята как отдельные товары от товаров, купленных онлайн NumWebPurchases и купленных в офлайн магазинах NumStorePurchases. В переменной Response (0) и (1) были заменены на "Клиент не откликнулся" и "Клиент откликнулся" соответственно. Для более корректного ответа на вопрос 3 из переменной 'Семейное положение' были удалены строки, имеющие семейный статус "Yolo", "Alone", "Absurd", поскольку эти семейные статусы встретились единично.

```{r}
# преобразование данных, предобработка
marketing = marketing %>% 
  mutate(Response = ifelse(Response == 0, "Клиент не откликнулся", "Клиент откликнулся"))
marketing = dplyr::rename(marketing, 'Траты на вино' = MntWines)
marketing = dplyr::rename(marketing, 'Отклик на кампанию' = Response)
marketing = rename(marketing,'Семейное положение' = Marital_Status)
marketing2 = marketing
marketing3 = marketing
marketing4 = marketing
marketing5 = marketing

```

### Исследовательские вопросы и тесты

#### Вопрос 1

**Вопрос:** Есть ли связь между готовность клиента откликнуться на кампанию с тем, сколько клиент потратил на вино?

```{r}
### Разведывательный анализ
marketing$`Отклик на кампанию` = as.factor(marketing$`Отклик на кампанию`)
library(ggplot2)
ggplot(data = marketing) +
  geom_boxplot(aes(x = `Отклик на кампанию`, y = `Траты на вино`)) +
  scale_fill_brewer(palette="Set2") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +
  ggtitle("Взаимосвязь отклика на кампанию и трат на вино")

```

```{r}
### Стат тест
t.test(`Траты на вино` ~ `Отклик на кампанию`, data = marketing)
```

**Ответ:** Существует статистическая взаимосвязь между откликом на маркетинговую кампанию и тратами клиента на вино за последние 2 года. У клиентов, которые откликнулись на кампанию, в среднем траты на вино статистически значимо выше на 236,7 ед.

**Вывод:** Была сфорулирована нулевая гипотеза о том, что взаимосвязи между переменными `Траты на вино` и `Отклик на кампанию` нет. По результатам теста Стьюдента, а именно: p-value 2.2e-16 < 0.05, нулевая гипотеза была отвергнута и была принята альтернативная, что взаимосвязь между данными переменными существует. 


#### Вопрос 2

**Вопрос:** Есть ли взаимосвязь между откликом клиентов на маркетинговую кампанию и долей товаров, купленных клиентами по скидкам?

```{r, message=F, warning=F}
### Преобразования
marketing2 = marketing
marketing2 = marketing2 %>% 
  mutate(percent = NumDealsPurchases/(NumWebPurchases + NumStorePurchases + NumDealsPurchases))
### Разведуем агрегацией
for_graph = group_by(marketing2, `Отклик на кампанию`)
for_graph = for_graph %>%
  filter(percent > 0) %>% 
  summarise(count = mean(percent))

### Строим график
graphik = ggplot(data = for_graph, aes(x = `Отклик на кампанию`, y = count))  +
  geom_bar(stat = "identity") +
 theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))

### Стат. тест
t.test(percent ~`Отклик на кампанию`, data = marketing2)
```
**Ответ:** Существует статистическая взаимосвязь между откликом клиентов на маркетинговую кампанию и долей товаров, купленных клиентами по скидкам. У клиентов, которые не откликнулись на кампанию, в среднем доля таких товаров статистически значимо выше на 0,0279895 ед или 2,8% процентных пункта.

**Вывод:** Была сфорулирована нулевая гипотеза о том, что взаимосвязи между переменными `percent`(доля товаров по скидке) и `Отклик на кампанию` нет. По результатам теста Стьюдента, а именно: p-value 0.0005641 < 0.05, нулевая гипотеза была отвергнута и была принята альтернативная, что взаимосвязь между данными переменными существует.

#### Вопрос 3

**Вопрос:** Есть ли взаимосвязь между откликом клиентов на маркетинговую кампанию и их семейным статусом?

```{r, message=F, warning=F}
marketing4$`Отклик на кампанию` = as.factor(marketing4$`Отклик на кампанию`)
marketing4$`Семейное положение` = as.factor(marketing4$`Семейное положение`)
marketing4_1 = filter(marketing4, marketing4$`Семейное положение` != "YOLO")
marketing4_1 = filter(marketing4, marketing4$`Семейное положение` != "Alone")
marketing4_1 = filter(marketing4, marketing4$`Семейное положение` != "Absurd")
library(vcd)

assoc(table(marketing4$`Семейное положение`, marketing4$`Отклик на кампанию`), gp=shading_max, 
      rot_labels = c(0, 0, 0, 0), 
      rot_varnames = c(0, 0, 0, 0), na.rm = TRUE)

### Стат. тест
chisq.test(marketing4_1$`Семейное положение`, marketing4_1$`Отклик на кампанию` )
```
**Ответ:** Существует статистическая взаимосвязь между откликом клиентов на маркетинговую кампанию и семейным положением клиентов. Клиенты, которые имеют семейный статус Divorced, Single, Widow, статистически значимо чаще откликались на маркетинговые кампании. Клиенты, которые имеют семейный статус Married, Together, статистически значимо реже откликались на приемную кампанию. 

**Вывод:** Была сфорулирована нулевая гипотеза о том, что взаимосвязи между переменными `Семеное положение` и `Отклик на кампанию` нет. По результатам теста Хи-Квадрат, а именно: p-value = 2.229e-09 < 0.05, нулевая гипотеза была отвергнута и была принята альтернативная, что взаимосвязь между данными переменными существует.

### Предсказание отклика на кампанию

Заказчиком была поставлена задача предсказать отклик на его кампанию по указанным им переменным: `Семейное положение`, `percent`(доля товаров по скидке), `Траты на вино`. На основании этого было построено дерево решений, которое имело 5 разбиений. Следующим шагом дерево было обрезано до 1 разбиеня (Предсказание по переменной `Траты на вино`) по complexity parameter = 0.018519, поскольку при этом значении cp наблюдается минимальная ошибка xerror(0.96667). Точность модели была рассчитана по обучающей и тестовой выборке как до отрезания дерева, так и после. Последний предсказанный отклик на тестовой выборке по Accuracy = 0.7902622 или 79%. Accuracy модели в обоих случаях была больше на тестовой выборке 80% > 78% и 79% > 76% соответственно. Полученные значения Accuracy говорят о том, что точность по тестовым выборкам в пределах изначального значения точности, даже лучше. Следовательно, можно говорить о удовлетворительном качестве модели и отсутствии переобучения.


```{r}
marketing3 = dplyr::rename(marketing2, 'Доля покупок по скидкам' = percent)
### Дерево
# Делим выборки
set.seed(999999)
# Возьмем 80% как обучающие
marketing3_train = marketing3 %>% sample_frac(.8)
marketing3_test = anti_join(marketing3, marketing3_train, by = 'ID') %>% select(-ID)
marketing3_train = marketing3_train %>% select(-ID)

set.seed(999999)
derevo3 <- rpart(`Отклик на кампанию` ~ `Траты на вино` +  `Доля покупок по скидкам` + `Семейное положение`, method = "class", data = marketing3_train)
rpart.plot(derevo3, extra = 2, type = 5)

```


```{r}
###Считаем accuracy для обучающей выборки
pred3 = predict(derevo3, type="class", marketing3 = marketing3_train)
t = table(pred3, marketing3_train$`Отклик на кампанию`)
(t[1,1] + t[2,2])/sum(t)


pred3_test = predict(derevo3, newdata = marketing3_test, type="class")

### Считаем Accuracy для тестовой выборки
z = table(pred3_test, marketing3_test$`Отклик на кампанию`)
(z[1,1] + z[2,2])/sum(z)
```

```{r}
printcp(derevo3)
```


```{r}
### Отрежем дерево по оптимальному cp = 0.018519
set.seed(999999)
derevo5 = prune(derevo3, cp = 0.018519)
rpart.plot(derevo5, extra = 2, type = 5)
```


```{r}
set.seed(999999)
derevo4 <- rpart(`Отклик на кампанию` ~ `Траты на вино` +  `Доля покупок по скидкам` + `Семейное положение`, method = "class", data = marketing3_train, cp = 0.018519)
```

```{r}
pred3 = predict(derevo4, type="class", marketing3 = marketing3_train)


##Считаем accuracy на обучающей выборке
t = table(pred3, marketing3_train$`Отклик на кампанию`)
 (t[1,1] + t[2,2])/sum(t)


pred3_test = predict(derevo4, newdata = marketing3_test, type="class")

### Считаем Accuracy на тестовой выборке
z = table(pred3_test, marketing3_test$`Отклик на кампанию`)
(z[1,1] + z[2,2])/sum(z)
```

## Общие выводы

Можно сделать вывод, что рекламная кампания франчайзи будет довольно удачной(предсказание 79% accuracy). Группы получились хорошими, переобучения/недообучения не произошло. Дерево после обрезания получилось всего в 1 split, но, считаю, что это неплохой результат, поскольку вопросы и переменные для получения красивого дерева специально подогнаны не были.